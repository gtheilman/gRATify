#!/bin/bash
set -e

env_file="/var/www/html/.env.example"

if [ ! -f "$env_file" ]; then
  echo "Missing .env.example in the image." >&2
  exit 1
fi

app_key="$(php artisan key:generate --show | tr -d '\r')"

awk -v key="$app_key" '
  BEGIN { replaced = 0 }
  /^APP_KEY=/ { print "APP_KEY=" key; replaced = 1; next }
  { print }
  END { if (!replaced) print "APP_KEY=" key }
' "$env_file"
