#!/usr/bin/env bash
set -euo pipefail

root_dir="$(git rev-parse --show-toplevel)"
changelog="${root_dir}/CHANGELOG.md"

if [[ ! -f "${changelog}" ]]; then
  exit 0
fi

commit_hash="$(git rev-parse --short=8 HEAD)"
commit_subject="$(git log -1 --pretty=%s)"
commit_date="$(git log -1 --pretty=%ad --date=short)"
entry="- ${commit_date} ${commit_subject} (${commit_hash})"

if grep -qF "${commit_hash}" "${changelog}"; then
  exit 0
fi

tmp_file="$(mktemp)"
awk -v entry="${entry}" '
  BEGIN { added = 0 }
  {
    print
    if (!added && $0 ~ /^## Unreleased/) {
      print ""
      print entry
      added = 1
    }
  }
' "${changelog}" > "${tmp_file}"

mv "${tmp_file}" "${changelog}"
